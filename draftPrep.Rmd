---
title: "2019 Draft Prep"
author: "Tom Kain"
date: "March 19, 2019"
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
knitr::opts_knit$set(stop_on_error = 2L)
source("R/yahoo_api.R")
source("R/z_scores.R")
options(tidyverse.quiet=TRUE)
library(knitr)
library(plotly)
library(tidyverse)
```

# Intro
Rather than loosely apply fantasy baseball expert rankings for traditionally-scored roto leagues, I wanted to take a stab at developing my own rankings based on several factors:

1. league-custom categories used for H2H scoring
2. quality projection data with realistic expectations for variance
3. my preferences for draft strategy and team management throughout the year

To that end, the below document is a walk-through of the various research completed in other R Markdown files found in this repo. 

### Scoring Categories
Here are the statistical categories which are used in our H2H categories, 12 team fantasy baseball league. Both team and category record are tracked throughout the year. 

##### Batters
- Runs (R)
- Hits (H)
- Home runs (HR)
- Runs Batted In (RBI)
- Stolen Bases (SB)
- Walks (BB)
- Strikeouts (SO/K)
- On-Base Percentage (OBP)
- On-Base Plus Slugging (OPS)
- \*Errors (E)

##### Pitchers
- Saves (SV)
- Strikeouts (SO/K)
- Holds (HLD)
- Earned Run Average (ERA)
- Walks+Hits per Inning (WHIP)
- \*No Hitters (NH)
- \*Quality Starts (QS)
- \*Blown Saves (BS)
- \*Complete Games (CG)
- \*Shut outs (SHO)

*Categories marked with an asterisk (\*) are not inluded in projection data.*

### Projection Data
Based on prior personal success and their construction is the average of two separate projections, I've downloaded the latest Fangraphs Depth Chart preseason projections. This data is joined with Yahoo position eligibility data, since this is our league's host. 

### Personal Strategy
After playing fantasy baseball for a few seasons and reading up from various experts (CBS Sports, The Athletic, etc), here are a few takeaways and preferences I prefer to take to heart at draft time as well as during the season.

1. Batter projections tend to be more accurate than pitchers
2. I tend to ride the waiver wire for starting pitching to take advantage of two-start weeks in an effort to find quality starts
3. Since more batting categories are projected than pitching categories, I tend to put more emphasis on getting hitters early in drafts

# Data Set
```{r importFangraphs, include=FALSE}
fangraphs_pitchers <- "data/fangraphs_pitchers.Rds"
fangraphs_batters <- "data/fangraphs_batters.Rds"
pitchers_file <- "data/depthChartProjections_pitchers_20190321.csv"
batters_file <- "data/depthChartProjections_batters_20190321.csv"

if (!file.exists(pitchers_file) || !file.exists(batters_file)) {
  stop("Couldn't find fangraphs export data in the data folder")
}

pitchers <- 
  pitchers_file %>%
  read_csv() %>%
  unique() %>% 
  mutate(type = "pitcher")

batters <- batters_file %>%
  read_csv() %>%
  unique() %>%
  mutate(type = "batter")

fangraphs <- pitchers %>% 
  bind_rows(batters) %>%
  filter(ADP < 999)

fangraphs$Name[fangraphs$Name == 'Enrique Hernandez'] <- "Kike Hernandez"
fangraphs$Name[fangraphs$Name == 'Cedric Mullins II'] <- "Cedric Mullins"
fangraphs$Name[fangraphs$Name == 'Michael Soroka'] <- "Mike Soroka"
fangraphs$Name[fangraphs$Name == 'Nathaniel Lowe'] <- "Nate Lowe"
fangraphs$Name[fangraphs$Name == 'Nathan Karns'] <- "Nate Karns"
fangraphs$Name[fangraphs$Name == 'Zach Britton'] <- "Zack Britton"
fangraphs$Name[fangraphs$Name == 'Joshua James'] <- "Josh James"
fangraphs$Name[fangraphs$Name == 'D.J. Stewart'] <- "DJ Stewart"
fangraphs$Name[fangraphs$Name == 'Daniel Poncedeleon'] <- "Daniel Ponce de Leon"

batters <- fangraphs %>%
  filter(type=="batter") %>%
  select(playerid,
         Name,
         Team,
         ADP,
         PA,
         H,
         HR:SO,
         SB,
         OBP,
         OPS)

pitchers <- fangraphs %>%
  filter(type=="pitcher") %>%
  select(playerid,
         Name,
         Team,
         ADP,
         IP,
         SV:ERA,
         SO,
         WHIP)

batters %>% saveRDS(fangraphs_batters)
pitchers %>% saveRDS(fangraphs_pitchers)

suppressWarnings(
  rm(fangraphs_pitchers, fangraphs_batters, pitchers_file, batters_file) 
)
```

```{r importYahoo, include=FALSE}
yahoo_file <- "data/players_position_eligibility.Rds"
if (file.exists(yahoo_file)) {
  yahoo_players <- readRDS(yahoo_file)
} else {
  get_players(2500) -> yahoo_players

  position_columns <- yahoo_players %>%
    select(starts_with("eligible_positions")) %>%
    colnames()
  
  yahoo_players %>%
    mutate(positions = paste(!!! syms(position_columns), sep = "," )) %>%
    mutate(positions = gsub('NA', '', positions)) %>%
    mutate(positions = gsub("^,*|(?<=,),|,*$", "", positions, perl=T)) %>%
    select(-(starts_with("eligible_positions"))) %>%
  select(name.full, display_position, positions) %>%
  mutate(name.full = chartr("áéóíñú", "aeoinu", name.full))  -> yahoo_players
  
  yahoo_players$name.full[yahoo_players$name.full == 'Shohei Ohtani (Batter)'] <- "Shohei Ohtani"
  yahoo_players$name.full[yahoo_players$name.full == 'Shin-soo Choo'] <- "Shin-Soo Choo"
  yahoo_players$name.full[yahoo_players$name.full == 'Seunghwan Oh'] <- "Seung Hwan Oh"
  yahoo_players$name.full[yahoo_players$name.full == 'JT Riddle'] <- "J.T. Riddle"
  yahoo_players$name.full[yahoo_players$name.full == 'AJ Reed'] <- "A.J. Reed"
  yahoo_players$name.full[yahoo_players$name.full == 'Dan Vogelbach'] <- "Daniel Vogelbach"
  
  
  yahoo_players %>% 
    saveRDS(yahoo_file)
}
rm(yahoo_file)
```

```{r include=FALSE}
players_master <- fangraphs %>%
  full_join(yahoo_players, by = c("Name" = "name.full")) %>%
  filter(!is.na(ADP)) %>%
  filter(ADP < 999)

players_master %>% 
  mutate(orphan = is.na(display_position) & is.na(positions)) %>%
  filter(orphan) -> orphans

if (!is.na(orphans) && nrow(orphans) > 0) {
  stop(paste0("Join resulted in ",nrow(orphans)," orphaned players"))
}
```
Here's a look at a few rows from each starting data set.

##### Batters
```{r echo=FALSE}
batters <- players_master %>%
  filter(type == "batter") %>%
  select(Name, Team, ADP, type, display_position, positions,
         PA, R, H, HR, RBI, SB, BB, SO, OBP, OPS,)

batters %>%
  select(-(type:positions)) %>%
  head()  %>%
  kable()
```

##### Pitchers
```{r echo=FALSE}
pitchers <- players_master %>%
  filter(type == "pitcher") %>%
  select(Name, Team, ADP, type, display_position, positions,
         IP, SV, SO, HLD, ERA, WHIP)

pitchers %>%
  select(-(type:positions)) %>%
  head()  %>%
  kable()
```

# Generate Rankings
I need to evaluate each player with a single metric that takes into account his relative rank in each scoring category. To do this, I'll generate z-scores for each scoring category via normalization, then sum the z-scores up per player to rank them. For rate statistics (i.e. OBP), the z_scores are controlled for batter's plate appearances (PA) and pitcher's innings pitched (IP). Here are the same batters with their z_scores computed:

```{r echo=FALSE}
batters %>%
  z_score_count(R) %>%
  z_score_count(H) %>%
  z_score_count(HR) %>%
  z_score_count(RBI) %>%
  z_score_count(SB) %>%
  z_score_count(BB) %>%
  z_score_count(SO, TRUE) %>%
  z_score_rate(OBP, PA) %>%
  z_score_rate(OPS, PA) %>%
  mutate(
    z_sum = pmap_dbl(
      select(., starts_with("z_")), 
      sum
    )
  ) -> batters

batters %>%
  head() %>%
  select(Name, Team, ADP, 
         z_H:z_sum) %>%
  kable()
```

I experimented with some additional adjustment for pitchers since there are four categories for which I don't have projections (note to self for the future, take some time to develop Quality Start projections). For now, no additional adjustment - here are the same pitchers with their z_scores.

```{r echo=FALSE}
pitchers %>%
  z_score_count(SV) %>%
  z_score_count(SO) %>%
  z_score_count(HLD) %>%
  z_score_rate(ERA, IP, TRUE) %>%
  z_score_rate(WHIP, IP, TRUE) %>%
  mutate(
    z_sum = pmap_dbl(
      select(., starts_with("z_")), 
      sum
    )
  ) -> pitchers

pitchers %>%
  head() %>%
  select(Name, Team, ADP, 
         z_SV:z_sum) %>%
  kable()
```

Let's compare the z_sum scores with average draft position (ADP).

```{r echo=FALSE}
z_sums <- pitchers %>%
  select(Name, type, ADP, z_sum)

batters %>%
  select(Name, type, ADP, z_sum) %>%
  bind_rows(z_sums) %>%
  arrange(desc(z_sum)) %>%
  mutate(z_rank = row_number()) -> z_sums

z_sums %>%
  ggplot(aes(x=ADP,y=z_rank,color=type)) +
  geom_point(aes(text=Name)) +
  geom_abline(slope=-1) +
  scale_y_reverse() -> p

ggplotly(p)
```

Some observations from this plot:

- Batters are in general weighed higher than pitchers since there are more categories with which to add to the z_sum
- Andrew Miller-like relievers are valued higher than ADP due to their high inning total and low ratio stats (ERA, WHIP)
- Ace starting pitchers and traditional closers are valued less than ADP despite their relative scarcity. 
  - Aces are the players most affected by not adjusting the z_score weighting for pitchers
  - Even with adjustment, tradtional closers have a lesser inning count nor have significant input in other categories to adjust their z_score very much
  
Thus far this is algining with my general strategy. These rankings value hitters highly, identify relievers to draft late, and leave it up to me to scrape for some starting pitchers to spring up over the course of the year. With this approach, I should be able to meaningfully attack most of the batting categories and a few of the pitching categories (i.e. ERA, WHIP, HLD), hopefully translating to a a weekly lead in categories. 

### Position Scarcity

What is not yet covered is batting lineup slots and offensive position scarcity. For example, catcher is traditionally very light on talent, but even the best offensive catcher is unlikely to crack the top 20. Here's a catcher that I happen to know is projected to be (one of) the best this year:
```{r echo=FALSE}
z_sums %>%
  select(Name, z_rank) %>%
  filter(grepl("Realmuto", Name)) %>%
  inner_join(batters, by = "Name") %>%
  select(Name, ADP, z_rank, z_sum) %>%
  kable()
```

J.T. Realmuto is going before the end of the third round yet by my ranking he shouldn't be going before the eleventh. However, I bet most catchers available to draft would have a negative z_sum, meaning they could be negating the benefit of taking higher z_sums from other positions with less bad options later in the draft. Let's confirm that.

```{r echo=FALSE}

z_sums %>%
  filter(type == "batter") %>%
  select(Name, z_rank) %>%
  full_join(batters, by = "Name") %>% 
  mutate(C = grepl("C", display_position)) %>%
  mutate(`1B` = grepl("1B", positions)) %>%
  mutate(`2B` = grepl("2B", positions)) %>%
  mutate(SS = grepl("SS", positions)) %>%
  mutate(`3B` = grepl("3B", positions)) %>%
  mutate(LF = grepl("LF", positions)) %>% 
  mutate(CF = grepl("CF", positions)) %>% 
  mutate(RF = grepl("RF", positions)) -> batters_ranked

z_sums %>%
  filter(type == "pitcher") %>%
  select(Name, z_rank) %>%
  full_join(pitchers, by = "Name") %>%
  mutate(SP = grepl("SP", positions)) %>%
  mutate(RP = grepl("RP", positions)) -> pitchers_ranked

C <- batters_ranked %>%
  filter(C) %>%
  mutate(position = "C")

`1B` <- batters_ranked %>%
  filter(`1B`) %>%
  mutate(position = "1B")

`2B` <- batters_ranked %>%
  filter(`2B`) %>%
  mutate(position = "2B")

`3B` <- batters_ranked %>%
  filter(`3B`) %>%
  mutate(position = "3B")

SS <- batters_ranked %>%
  filter(SS) %>%
  mutate(position = "SS")

LF <- batters_ranked %>%
  filter(LF) %>%
  mutate(position = "LF")

CF <- batters_ranked %>%
  filter(CF) %>%
  mutate(position = "CF")

RF <- batters_ranked %>%
  filter(RF) %>%
  mutate(position = "RF")

SP <- pitchers_ranked %>% 
  filter(SP) %>% 
  mutate(position = "SP")

RP <- pitchers_ranked %>% 
  filter(RP) %>% 
  mutate(position = "RP")

pitcher_positions_ranked <- SP %>%
  bind_rows(RP) %>%
  select(Name, ADP, z_sum, position) %>%
  unique()

positions_ranked <- C %>%
  bind_rows(`1B`) %>%
	bind_rows(`2B`) %>%
	bind_rows(`3B`) %>%
	bind_rows(SS) %>%
  bind_rows(LF) %>% 
  bind_rows(CF) %>% 
  bind_rows(RF) %>% 
  select(Name, ADP, z_sum, position) %>% 
  unique() %>%
  bind_rows(pitcher_positions_ranked) %>%
  arrange(z_sum %>% desc) %>%
  mutate(round = ceiling(ADP/12),
         z_rank = row_number(),
         position = fct_relevel(position, "C","1B", "2B","3B","SS","LF","CF","RF","SP","RP"))

positions_ranked %>%
  filter(ADP <= 300,
         !position %in% c("SP","RP")) %>%
  ggplot(aes(x=position, y=z_sum)) +
  geom_boxplot() +
  geom_jitter(aes(text=Name, alpha=desc(round)), width = .2) +
  geom_abline(slope=0, intercept = 0, linetype = "dotted") +
  labs(x="Position",
       y="Z_Points",
       title="Batter value by position, top 300 drafted") -> pt

ggplotly(pt)
```

This highlights how poor the catcher position is. The upper outliers at the position are roughly equivlanet to the median value of most other positions. If I don't get one of the top four catchers, I'll need to at least make up the 4 z_points somewhere else. That said, the projections indicate that I would do nearly as well with Yasmani Grandal or Buster Posey (rounds 13 and 10, respectively) as I would with the higher in demand J.T. Realmuto and Gary Sanchez (rounds 4 and 5 respectively). 

# Draft Prep
Armed with this information, here's what I need before the draft:

1. Exclude known keepers from this list - no sense planning on a player being available if they won't be
2. Add pitchers to the above plot so that I can...
3. ...put together a basic plan of attack for the draft
4. Generate a cheat sheet document to use for the draft

```{r echo=FALSE}

keepers <- c(
  "Justin Turner",
  "Miles Mikolas",
  "Whit Merrifield",
  "Archie Bradley",
  "Patrick Corbin",
  "Matt Carpenter",
  "Blake Treinen",
  "Ronald Acuna Jr.",
  "Blake Snell",
  "Lorenzo Cain",
  "Trevor Story",
  "Andrew Benintendi",
  "Mike Clevinger"
)

positions_ranked %>%
  mutate(keeper = (Name %in% keepers)) -> positions_ranked_with_keepers

positions_ranked_with_keepers %>%
  filter(ADP <= 300,
         !keeper) %>%
  ggplot(aes(x=position, y=z_sum)) +
  geom_boxplot() +
  geom_jitter(aes(text=Name, alpha=desc(round)), width = .2) +
  geom_abline(slope=0, intercept = 0, linetype = "dotted") +
  labs(x="Position",
       y="Z_Points",
       title="Player value by position, top 300 drafted, keepers excluded ") -> ptk

ggplotly(ptk)
```

```{r echo=FALSE}
positions_ranked_with_keepers %>%
  filter(!keeper,
         ADP <=300) %>%
  arrange(round, position) %>%
  mutate(round = as_factor(round)) %>%
  mutate(round = fct_inseq(round, ordered = TRUE)) %>%
  ggplot(aes(x=round,y=z_sum,alpha=desc(z_rank),size=z_sum,color=position)) +
  geom_jitter(aes(text=Name)) +
  facet_wrap(~ position) -> rv

ggplotly(rv)
```
*Note, one of the excluded keepers is mine - SS Trevor Story, round 11*

I'd like to put together a plan of attack where, for each round, I identify the kinds of players available at the highest projected scoring, perhaps in tiers of z_scores: >= 15, 10-15, 5-10, etc. Let's start with the upper tier:

##### Elite Tier (z_score >= 15)

```{r echo = FALSE}
positions_ranked_with_keepers %>%
  filter(z_sum >= 15, !keeper) %>%
  select(Name, z_sum, ADP, round) %>%
  unique() %>%
  arrange(ADP) %>%
  kable()
```

We should assume Trout, Betts, and Ramirez will go 1,2,3, or at least not make it to me at 11. However, according to the projection data, Bryce Harper & Juan Soto could be available, potentially worth getting at the rounds 1 & 2 turn. 

##### Damn Good Tier (z_score between 10 and 15)

```{r echo = FALSE}
positions_ranked_with_keepers %>%
  filter(between(z_sum,10,15), !keeper) %>%
  ggplot(aes(position,z_sum,size=round,color=Name)) +
  geom_jitter(aes(text=Name), width = .2) -> dgt

ggplotly(dgt)

positions_ranked_with_keepers %>%
  filter(between(z_sum,10,15), !keeper) %>%
  count(position) %>%
  arrange(desc(n)) %>%
  kable()
```

At the top of this tier are two first basemen (Votto, Rizzo) and two outfielders (Yelich, Martinez). Votto has been going late enough (round 6) that I can afford to wait, giving me some fallback options in the OF if Harper and Soto are not available first. Although Bregman and Judge are next up, I'm thinking Jose Altuve might be a good pick since 2B is relatively scarce compared to OF and 3B. 

##### Pretty Good Tier

```{r echo=FALSE}
positions_ranked_with_keepers %>%
  filter(between(z_sum,5,10), !keeper) %>%
  ggplot(aes(position,z_sum,size=round,color=Name)) +
  geom_jitter(aes(text=Name), width = .2) -> dgt

ggplotly(dgt)

positions_ranked_with_keepers %>%
  filter(between(z_sum,5,10), !keeper) %>%
  count(position) %>%
  arrange(desc(n)) %>%
  kable()
```
