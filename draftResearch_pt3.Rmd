---
title: "Draft Research pt3"
author: "Tom Kain"
date: "March 11, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(tidyverse.quiet=TRUE)
library(plotly)
library(tidyverse)
```

# Join Data
Let's see if we can join the eligible position data (Yahoo) with the projection data (Fangraphs).

```{r}
yahoo <- readRDS('data/players_position_eligibility.Rds') %>%
  select(name.full, display_position, positions) %>%
  mutate(name.full = chartr("áéóíñú", "aeoinu", name.full))

yahoo$name.full[yahoo$name.full == 'Daniel Vogelbach'] <- "Dan Vogelbach"
yahoo$name.full[yahoo$name.full == 'Shohei Ohtani (Batter)'] <- "Shohei Ohtani"
yahoo$name.full[yahoo$name.full == 'Shin-soo Choo'] <- "Shin-Soo Choo"
yahoo$name.full[yahoo$name.full == 'Seunghwan Oh'] <- "Seung Hwan Oh"
yahoo$name.full[yahoo$name.full == 'JT Riddle'] <- "J.T. Riddle"
yahoo$name.full[yahoo$name.full == 'AJ Reed'] <- "A.J. Reed"

fangraphs <- readRDS('data/z_compare_adj.Rds')

fangraphs$Name[fangraphs$Name == 'Enrique Hernandez'] <- "Kike Hernandez"
fangraphs$Name[fangraphs$Name == 'Cedric Mullins II'] <- "Cedric Mullins"
fangraphs$Name[fangraphs$Name == 'Michael Soroka'] <- "Mike Soroka"
fangraphs$Name[fangraphs$Name == 'Nathaniel Lowe'] <- "Nate Lowe"
fangraphs$Name[fangraphs$Name == 'Nathan Karns'] <- "Nate Karns"
fangraphs$Name[fangraphs$Name == 'Zach Britton'] <- "Zack Britton"
fangraphs$Name[fangraphs$Name == 'Joshua James'] <- "Josh James"
fangraphs$Name[fangraphs$Name == 'D.J. Stewart'] <- "DJ Stewart"

df_join <- fangraphs %>%
  full_join(yahoo, by = c("Name" = "name.full")) %>%
  filter(!is.na(ADP))

df_join %>% 
  count(is.na(display_position) & is.na(positions))
```

#### Orphaned Records after join fixes
1. Replaced accented characters to characters without accents
2. Fuzzy join
3. Yahoo API query for *2500* players (rather than 850)
4. Duplicate Shohei Ohtani records, lack of pitching projections
5. Multiple player minor name mismatches

# Compare positions

```{r}
df_join_positions <-
  df_join %>%
  filter(ovrl_rank <= 400) %>%
  mutate(SP = grepl("SP", display_position)) %>%
  mutate(RP = grepl("RP", display_position)) %>%
  mutate(C = grepl("C", display_position)) %>%
  mutate(`1B` = grepl("1B", display_position)) %>%
  mutate(`2B` = grepl("2B", display_position)) %>%
  mutate(SS = grepl("SS", display_position)) %>%
  mutate(`3B` = grepl("3B", display_position)) %>%
  mutate(OF = grepl("OF", display_position))

df_join_positions %>% saveRDS("data/projections_with_positions.Rds")

position_plot <- function(df, pos) {
  pos_var <- enquo(pos)
  title <- paste0(quo_name(pos_var))
  
  df %>%
    filter(!! pos_var) %>%
    ggplot(aes(x=ADP, y=ovrl_rank, alpha = z_sum)) + 
    geom_point(aes(text=Name)) +
    scale_y_reverse() +
    geom_abline(slope = -1)
}

sp_plot <- position_plot(df_join_positions, SP)
rp_plot <- position_plot(df_join_positions, RP)
c_plot <- position_plot(df_join_positions, C)
`1b_plot` <- position_plot(df_join_positions, `1B`)
`2b_plot` <- position_plot(df_join_positions, `2B`)
ss_plot <- position_plot(df_join_positions, SS)
`3b_plot` <- position_plot(df_join_positions, `3B`)
of_plot <- position_plot(df_join_positions, OF)

subplot(sp_plot , rp_plot , c_plot , `1b_plot`, `2b_plot`, ss_plot , `3b_plot`, of_plot, nrows = 3, shareX = TRUE, shareY = TRUE)
```

Confirming keeper pick of Trevor Story...
```{r}
df_join_positions %>%
  filter(grepl("Story|Rendon",Name)) %>%
  select(Name, ADP, ovrl_rank, z_sum, PA:z_OPS) %>%
  View()
```

# Tiers

```{r}
SP <- df_join_positions %>%
  filter(SP) %>%
  mutate(position = "SP")

RP <- df_join_positions %>%
  filter(RP) %>%
  mutate(position = "RP")

C <- df_join_positions %>%
  filter(C) %>%
  mutate(position = "C")

`1B` <- df_join_positions %>%
  filter(`1B`) %>%
  mutate(position = "1B")

`2B` <- df_join_positions %>%
  filter(`2B`) %>%
  mutate(position = "2B")

`3B` <- df_join_positions %>%
  filter(`3B`) %>%
  mutate(position = "3B")

SS <- df_join_positions %>%
  filter(SS) %>%
  mutate(position = "SS")

OF <- df_join_positions %>%
  filter(OF) %>%
  mutate(position = "OF")

positions_tiers <- SP %>%
	bind_rows(RP) %>%
	bind_rows(C) %>%
	bind_rows(`1B`) %>%
	bind_rows(`2B`) %>%
	bind_rows(`3B`) %>%
	bind_rows(SS) %>%
	bind_rows(OF ) %>%
  select(Name, ADP, z_sum, ovrl_rank, position) %>%
  mutate(round = ceiling(ADP/12))

positions_tiers %>%
  select(ADP, round) %>% head(25)

positions_tiers %>%
  filter(z_sum > 0) %>%
  ggplot(aes(x=position, y=z_sum, alpha = desc(round))) +
  geom_jitter(aes(text=Name), width = .3) -> pt

ggplotly(pt)
```

### Players available in even numbered rounds
I'm picking 11 of 12, which means I'll be getting the tail end of odd number rounds and getting the jump on even numbered rounds. So, let's just see what kind of team I can make up assuming two picks per even round. 

```{r}
positions_tiers %>%
  filter(round > 23) %>%
  ggplot(aes(x=position, y=z_sum, alpha = desc(round))) +
  geom_jitter(aes(text=Name), width = .3) -> pt_even

ggplotly(pt_even)
```
```{r}

drafted_players_190316 <- c(
  "Chris Sale",
  "Bryce Harper",
  "Joey Votto",
  "Carlos Carrasco",
  "Justin Turner",
  "Daniel Murphy",
  "Joey Gallo",
  "Josh Hader",
  "Aaron Hicks",
  "Carlos Santana",
  "Trevor Story",
  "Dellin Betances",
  "David Robertson",
  "Will Smith",
  "Andrew Miller",
  "Kyle Schwarber",
  "Josh Bell",
  "Soo Choo",
  "Brandon Belt",
  "Chad Green",
  "Wilmer Flores",
  "Keone Kela",
  "Ryan Pressly"
  )

drafted_team_190316 <- df_join_positions %>%
  filter(Name %in% drafted_players) 

drafted_batters_190316 <- drafted_team_190316 %>%
  filter(type == "Batter") %>%
  mutate(OB = PA * OBP,
         SLG = OPS - OBP,
         AB = PA - H,
         TB = SLG * AB) %>%
  summarize(PA = sum(PA),
            H = sum(H),
            HR = sum(HR),
            R = sum(R),
            RBI = sum(RBI),
            BB = sum(BB),
            SO = sum(SO),
            SB = sum(SB),
            OBP = sum(OB) / PA,
            SLG = sum(TB) / sum(AB),
            OPS = OBP + SLG
            )

drafted_pitchers_190316 <- drafted_team_190316 %>% 
  filter(type == "Pitcher") %>%
  mutate(ER = IP/9 * ERA,
         runners = WHIP * IP) %>%
  summarize(IP = sum(IP),
            SV = sum(SV),
            HLD = sum(HLD),
            ERA = sum(ER) / (IP/9),
            WHIP = sum(runners) / IP) 

drafted_team_stats_190316 <- drafted_batters_190316 %>%
  bind_cols(drafted_pitchers_190316)

```

### To Do
1. Develop tiers of players (linear model? nearest neighbor?)
2. Replacement level stuff (new section)
3. Take averages of multiple projection sources? 
4. Build team stats based on selections, available players per round? 
5. Exclude known keepers