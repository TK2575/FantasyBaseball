---
title: "Trade Reviews"
author: "Tom Kain"
date: "April 5, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(glue)
library(plotly)
```

Various trade scenarios to review during the year.

## Early April
Targeting a 3B, considering Chris's team as a trade partner since he has multiple high value 3B and needs 1B, RP. I'll need to...

1. Get the latest ROS projection data, calculate z_scores
2. Get the players for both teams with their eligible positions
3. Get draft results
4. Join roster, projection, and draft result data, rescale z_scores appropriately
5. Identify some equitable trade scenarios keeping as close to a net even z_score exchange

#### Latest ROS Projection data, calculate z_scores
```{r}
source("R/z_scores.R")
proj_batter_raw <- read_csv("data/depthChartProjections_ros_batters_20190405.csv") 
proj_pitcher_raw <- read_csv("data/depthChartProjections_ros_pitchers_20190405.csv") 
  

proj_batter_raw %>%
  z_score_count(R) %>%
  z_score_count(H) %>%
  z_score_count(HR) %>%
  z_score_count(RBI) %>%
  z_score_count(SB) %>%
  z_score_count(BB) %>%
  z_score_count(SO, TRUE) %>%
  z_score_rate(OBP, PA) %>%
  z_score_rate(OPS, PA) %>%
  mutate(
    z_sum = pmap_dbl(
      select(., starts_with("z_")), 
      sum
    ),
    type = "batter") %>% 
  select(Name, type, z_sum) -> proj_batter

proj_pitcher_raw %>%
  z_score_count(SV) %>%
  z_score_count(SO) %>%
  z_score_count(HLD) %>%
  z_score_rate(ERA, IP, TRUE) %>%
  z_score_rate(WHIP, IP, TRUE) %>%
  mutate(
    z_sum = pmap_dbl(
      select(., starts_with("z_")), 
      sum
    ),
    type = "pitcher") %>% 
  select(Name, type, z_sum) -> proj_pitcher

```

#### Fantasy team rosters
```{r}
source("R/yahoo_api.R")
league_string <- paste0("388.l.",Sys.getenv("LEAGUE_KEY"))
get_team_rosters(league_string) -> rosters
  
```

#### Draft results
```{r}
draft_results_raw <- read_tsv("data/draftResults.tsv") %>% 
  clean_names()

draft_results <- draft_results_raw %>% 
  mutate(player = chartr("áéóíñú", "aeoinu", player)) %>% 
  select(pick, player)
```

#### Join data
```{r}
projections <- proj_batter %>% 
  bind_rows(proj_pitcher)

projections$Name[projections$Name == 'Enrique Hernandez'] <- "Kike Hernandez"
projections$Name[projections$Name == 'Peter Alonso'] <- "Pete Alonso"
projections$Name[projections$Name == 'Joshua James'] <- "Josh James"

rosters %>% 
  left_join(draft_results, by = c("name_full" = "player")) %>% 
  full_join(projections, by = c("name_full" = "Name")) %>% 
  mutate(team = if_else(is.na(team),"Free Agent",team),
         team = fct_reorder(team, z_sum)) -> rosters_with_projections

rosters_with_projections %>% 
  saveRDS("data/rosters_with_projections_20190405.Rds")
```

#### Evaluate trade options
```{r}
rosters_with_projections %>% 
  filter(grepl('Tom|Christopher',manager)) %>% 
  select(manager, name_full, display_position, pick, z_sum) %>%  
  mutate(z_sum = round(z_sum)) %>% 
  arrange(z_sum %>% desc, pick) %>% 
  View()
```

## Other research

```{r}
rosters_with_projections %>% 
  mutate(z_sum = round(z_sum)) %>% 
  ggplot(aes(x=team,y=z_sum,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type))) +
  coord_flip() -> p

ggplotly(p)

rosters_with_projections %>% 
  filter(!type == 'NA', !team == 'Free Agent') %>%
  ggplot(aes(x=type,y=z_sum)) +
  geom_boxplot()

rosters_with_projections %>% 
  filter(!type == 'NA', !team == 'Free Agent') %>%
  group_by(type) %>% 
  summarize(adj = median(z_sum)) -> z_sum_adj

rosters_with_adj_projections <- rosters_with_projections %>% 
  filter(!type == 'NA') %>% 
  mutate(zar = if_else(type=="batter",
                       z_sum-z_sum_adj$adj[z_sum_adj$type=="batter"],
                       z_sum-z_sum_adj$adj[z_sum_adj$type=="pitcher"]))

rosters_with_adj_projections %>% 
  ggplot(aes(x=type,y=zar)) +
  geom_boxplot()

rosters_with_adj_projections %>% 
  mutate(zar = round(zar)) %>% 
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type))) +
  coord_flip() -> z

ggplotly(z)

rosters_with_adj_projections %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 0)) %>% 
  arrange(zar %>% desc) %>% 
  select(name_full, display_position, type, zar) %>% 
  View()
```