---
title: "Trade Reviews"
author: "Tom Kain"
date: "April 5, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(glue)
library(plotly)
library(stringi)
```

Various trade scenarios to review during the year.

## Early April
Targeting a 3B, considering Chris's team as a trade partner since he has multiple high value 3B and needs 1B, RP. I'll need to...

1. Get the latest ROS projection data, calculate z_scores
2. Get the players for both teams with their eligible positions
3. Get draft results
4. Join roster, projection, and draft result data, rescale z_scores appropriately
5. Identify some equitable trade scenarios keeping as close to a net even z_score exchange

#### Latest ROS Projection data, calculate z_scores
```{r}
source("R/z_scores.R")
proj_batter_raw <- read_csv("data/depthChartProjections_ros_batters_20190405.csv") 
proj_pitcher_raw <- read_csv("data/depthChartProjections_ros_pitchers_20190405.csv") 
  

proj_batter_raw %>%
  z_score_count(R) %>%
  z_score_count(H) %>%
  z_score_count(HR) %>%
  z_score_count(RBI) %>%
  z_score_count(SB) %>%
  z_score_count(BB) %>%
  z_score_count(SO, TRUE) %>%
  z_score_rate(OBP, PA) %>%
  z_score_rate(OPS, PA) %>%
  mutate(
    z_sum = pmap_dbl(
      select(., starts_with("z_")), 
      sum
    ),
    type = "batter") %>% 
  select(Name, type, z_sum) -> proj_batter

proj_pitcher_raw %>%
  z_score_count(SV) %>%
  z_score_count(SO) %>%
  z_score_count(HLD) %>%
  z_score_rate(ERA, IP, TRUE) %>%
  z_score_rate(WHIP, IP, TRUE) %>%
  mutate(
    z_sum = pmap_dbl(
      select(., starts_with("z_")), 
      sum
    ),
    type = "pitcher") %>% 
  select(Name, type, z_sum) -> proj_pitcher

```

#### Draft results
```{r}
draft_results_raw <- read_tsv("data/draftResults.tsv") %>% 
  clean_names()

draft_results <- draft_results_raw %>% 
  mutate(player = stri_trans_general(player, "latin-ascii")) %>% 
  select(pick, player)
```

#### Join with roster data
```{r}
if (!file.exists("data/rosters_with_projections_20190405.Rds")) {
  source("R/yahoo_api.R")
  get_team_rosters() -> rosters
  
  projections <- proj_batter %>% 
    bind_rows(proj_pitcher)
  
  projections$Name[projections$Name == 'Enrique Hernandez'] <- "Kike Hernandez"
  projections$Name[projections$Name == 'Peter Alonso'] <- "Pete Alonso"
  projections$Name[projections$Name == 'Joshua James'] <- "Josh James"
  
  rosters %>% 
    left_join(draft_results, by = c("name_full" = "player")) %>% 
    full_join(projections, by = c("name_full" = "Name")) %>% 
    mutate(team = if_else(is.na(team),"Free Agent",team),
           team = fct_reorder(team, z_sum)) -> rosters_with_projections
  
  rosters_with_projections %>% 
    saveRDS("data/rosters_with_projections_20190405.Rds")
} else {
  rosters_with_projections <- readRDS("data/rosters_with_projections_20190405.Rds")
}

```

#### Evaluate trade options
```{r}
rosters_with_projections %>% 
  filter(grepl('Tom|Christopher',manager)) %>% 
  select(manager, name_full, display_position, pick, z_sum) %>%  
  mutate(z_sum = round(z_sum)) %>% 
  arrange(z_sum %>% desc, pick) %>% 
  View()
```