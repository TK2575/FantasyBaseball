---
title: "Roster Review 2"
author: "Tom Kain"
date: "April 22, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(glue)
library(plotly)
library(stringi)
source("R/z_scores.R")
source("R/yahoo_api.R")
```


```{r}
draft_results <- read_tsv("data/draftResults.tsv") %>% 
    clean_names() %>% 
    mutate(player = stri_trans_general(player, "latin-ascii")) %>% 
    select(pick, player)

if (!file.exists("data/rosters_with_projections_20190422.Rds")) {
  
  if (!file.exists("data/rosters_20190422.Rds")) {
    get_team_rosters() -> rosters
    rosters %>% 
      saveRDS("data/rosters_20190422.Rds")
  } else {
    rosters <- readRDS("data/rosters_20190422.Rds")
  }
  
  if (!file.exists("data/yahoo_players_20190422.Rds")) {
    yahoo_players <- get_players(2500)
    yahoo_players %>% 
      saveRDS("data/yahoo_players_20190422.Rds")
  } else {
    yahoo_players <- readRDS("data/yahoo_players_20190422.Rds")
  }
  
  all_players <- rosters %>% 
    select(player_id, team, manager) %>% 
    full_join(yahoo_players) %>% 
    clean_names() %>% 
    mutate(name_full = stri_trans_general(name_full, "latin-ascii"))
  
  proj_batter <- add_z_scores_to_projections("data/depthChartProjections_ros_batters_20190422.csv","batter") 
  proj_pitcher <- add_z_scores_to_projections("data/depthChartProjections_ros_pitchers_20190422.csv", "pitcher")
  
  projections <- proj_batter %>% 
    bind_rows(proj_pitcher)

  projections$Name[projections$Name == 'Enrique Hernandez'] <- "Kike Hernandez"
  projections$Name[projections$Name == 'Peter Alonso'] <- "Pete Alonso"
  projections$Name[projections$Name == 'Joshua James'] <- "Josh James"

  all_players %>% 
    #left_join(draft_results, by = c("name_full" = "player")) %>% 
    full_join(projections, by = c("name_full" = "Name")) %>% 
    mutate(team = if_else(is.na(team),"Free Agent",team),
           team = fct_reorder(team, z_sum)) -> rosters_with_projections

  rosters_with_projections %>% 
    saveRDS("data/rosters_with_projections_20190422.Rds")
  
} else {
  rosters_with_projections <- readRDS("data/rosters_with_projections_20190409.Rds")
}

```

```{r}
rosters_with_projections %>% 
  filter(!type == 'NA', !team == 'Free Agent') %>%
  group_by(type) %>% 
  summarize(adj = median(z_sum)) -> z_sum_adj

rosters_with_adj_projections <- rosters_with_projections %>% 
  filter(!type == 'NA') %>% 
  mutate(zar = if_else(type=="batter",
                       z_sum-z_sum_adj$adj[z_sum_adj$type=="batter"],
                       z_sum-z_sum_adj$adj[z_sum_adj$type=="pitcher"]))
```

```{r}
rosters_with_adj_projections %>% 
  mutate(zar = round(zar)) %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 0)) %>% 
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type))) +
  coord_flip() -> pa

ggplotly(pa)

rosters_with_adj_projections %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 0)) %>% 
  arrange(zar %>% desc) %>% 
  select(name_full, display_position, type, zar) %>% 
  View()
```

```{r}
rosters_with_adj_projections %>% 
  filter(grepl('2B',display_position)) %>% 
  ggplot(aes(x=team,y=zar,color=team)) +
  geom_point(aes(text=name_full)) +
  coord_flip() -> sb

ggplotly(sb)

rosters_with_adj_projections %>% 
  filter(grepl('3B',display_position)) %>% 
  ggplot(aes(x=team,y=zar,color=team)) +
  geom_point(aes(text=name_full)) +
  coord_flip() -> tb

ggplotly(tb)

rosters_with_adj_projections %>%
  filter(type == 'batter') %>% 
  mutate(third_base = grepl('3B',display_position),
         second_base = grepl('2B',display_position),
         position = case_when(
           third_base & second_base ~ 'Both',
           third_base ~ '3B',
           second_base ~ '2B',
           TRUE ~ "Other")) %>% 
  mutate(team = fct_relevel(team, "Plouffe There It Is!")) %>% 
  ggplot(aes(x=team,y=zar,color=position)) +
  geom_point(aes(text=name_full)) +
  coord_flip() -> both

ggplotly(both)

rosters_with_adj_projections %>% 
  filter(team == 'Free Agent', 
         grepl('2B|3B',display_position)) %>% 
  arrange(zar %>% desc) %>% 
  head(30) %>% 
  View()

```

```{r}
proj_batter %>% 
  mutate(zar = if_else(type=="batter",
                       z_sum-z_sum_adj$adj[z_sum_adj$type=="batter"],
                       z_sum-z_sum_adj$adj[z_sum_adj$type=="pitcher"])) %>% 
  filter(grepl("Frazier|Voit|Bell|Bradley|Flores",Name)) %>% 
  arrange(zar %>% desc) %>% 
  select(Name, Team, zar, G:z_sum) %>% 
  View()
```

```{r}
players <- get_players() %>% 
  clean_names() %>% 
  mutate(name_full = stri_trans_general(name_full, "latin-ascii"))

View(players)
```
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
