---
title: "Roster Review (Generic)"
author: "Tom Kain"
date: "April 25, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(glue)
library(plotly)

source("R/helper.R")
```


```{r}
force_fetch <- FALSE
force_join <- FALSE
batter_file <- "temp/FanGraphs Leaderboard.csv"
pitcher_file <- "temp/FanGraphs Leaderboard (1).csv"

if (force_fetch && (batter_file %>% is.null() || pitcher_file %>% is.null())) {
  stop("Need projection files to force a recalc")
} else {
  rosters <- load_players_with_projections(force_fetch, 
                                           force_join, 
                                           batter_file, 
                                           pitcher_file)
}

#TODO review duplicates
```

```{r}
rosters_by_position <- row_per_position(rosters)

optimal_lineups_offense <- rosters_by_position %>% 
  optimal_lineup()

```

```{r}
#TODO abstract some of these views
rosters %>% 
  mutate(zar = round(zar)) %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 2)) %>% 
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type))) +
  coord_flip() -> pa

ggplotly(pa)

rosters %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 2)) %>% 
  arrange(zar %>% desc) %>% 
  mutate(zar = zar %>% round(digits=1)) %>% 
  select(team, name_full, positions, type, zar) %>% 
  View("Available Free Agents")
```

```{r}
rosters_by_position %>% 
  filter(team != "Free Agent") %>% 
  ggplot(aes(position, zar, color = position, alpha = zar)) +
  geom_point(aes(text=name_full)) +
  facet_wrap(~ team) -> team_pos

ggplotly(team_pos)

rosters_by_position %>% 
  select(team, manager, name_full, position, zar, pos_zar) %>% 
  # filter(position %in% c('SP','RP')) %>% 
  filter(grepl("Plouffe",team)) %>% 
  arrange(pos_zar %>% desc) %>%
  mutate(pos_zar = pos_zar %>% round(1),
         zar = zar %>% round(1)) %>% 
  View("ZAR by Position")
  
rosters_by_position %>% 
  filter(team != "Free Agent") %>% 
  ggplot(aes(position, pos_zar, color = position, alpha = zar)) +
  geom_point(aes(text=name_full)) +
  facet_wrap(~ team) -> team_pos_adj

ggplotly(team_pos_adj)

# FIXME join optimal offense lineup with all pitching
rosters_by_position %>% 
  filter(team != "Free Agent") %>% 
  group_by(team, position) %>% 
  summarize(avg_pos_zar = mean(pos_zar)) -> team_pos_avg_zar

team_pos_avg_zar %>%  
  ggplot(aes(position, avg_pos_zar, color = position)) +
  geom_point() +
  facet_wrap(~ team) -> team_avg_pos

ggplotly(team_avg_pos)

team_pos_avg_zar %>% 
  ungroup() %>% 
  group_by(team) %>% 
  summarize(sum_pos_zar = sum(avg_pos_zar),
            mean_pos_zar = mean(avg_pos_zar),
            var_pos_zar = sd(avg_pos_zar)) %>% 
  arrange(mean_pos_zar %>% desc)

rosters_by_position %>% 
  filter(team != "Free Agent") %>% 
  ggplot(aes(pos_zar)) + 
  geom_freqpoly(binwidth=.25) + 
  facet_wrap(~ position)
```

```{r}
# TODO find way to wrap these three views into one
rosters %>% 
  filter(grepl("Plouffe|Mata",team)) %>% 
  select(team, manager, name_full, display_position, zar, positions) %>% 
  arrange(zar %>% desc) %>% 
  mutate(zar = zar %>% round(1)) %>% 
  View("Trade Partner")
  # mutate(zar = janitor::round_half_up(zar)) %>% 
  # write_csv("data/tradeReview_20190423.csv")

rosters %>% 
  filter(grepl("Plouffe|Mata",team)) %>% 
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type)), width=.2) +
  coord_flip() -> tv

ggplotly(tv)

rosters %>% 
  #filter(grepl("Plouffe|Oakmont|Nuts",team)) %>% 
  select(team, manager, name_full, display_position, zar) %>% 
  filter(grepl("Benintendi|Martin Perez",name_full)) 
# %>%
#   group_by(team) %>%
#   summarize(zar = sum(zar))
```

```{r}
rosters %>% 
  filter(!grepl("Free Agent",team)
  #        ,
  # grepl("CF",positions)
       ) %>%
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_boxplot() +
  # geom_jitter(aes(text=name_full), width = .2) +
  coord_flip() -> tb

ggplotly(tb)
```

```{r}
#TODO measuring projected value of draft picks, move to separate research
#TODO get beginning of year zar/war values
rosters %>% 
  filter(!is.na(draft_pick)) %>%
  group_by(draft_round) %>% 
  summarize(zar_median = median(zar) %>% janitor::round_half_up(),
            zar_mean = mean(zar) %>% janitor::round_half_up()) %>%
  ggplot(aes(x=draft_round,y=zar_mean)) +
  geom_col() +
  geom_line(aes(y=zar_median)) -> draft_plot

ggplotly(draft_plot)

rosters %>% 
  filter(!is.na(draft_pick)) %>% 
  group_by(draft_round) %>% 
  arrange(draft_round) %>% 
  ggplot(aes(x=draft_round,y=zar,group=draft_round)) +
  geom_boxplot()

rosters %>% 
  filter(!is.na(draft_pick)) %>%
  group_by(draft_round) %>% 
  summarize(war_median = median(war) %>% janitor::round_half_up(),
            war_mean = mean(war) %>% janitor::round_half_up()) %>%
  ggplot(aes(x=draft_round,y=war_mean)) +
  geom_col() +
  geom_line(aes(y=war_median)) -> draft_plot_war

ggplotly(draft_plot_war)

rosters %>% 
  filter(!is.na(draft_pick)) %>% 
  group_by(draft_round) %>% 
  arrange(draft_round) %>% 
  ggplot(aes(x=draft_round,y=war,group=draft_round)) +
  geom_boxplot()
```