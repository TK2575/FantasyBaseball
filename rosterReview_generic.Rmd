---
title: "Roster Review (Generic)"
author: "Tom Kain"
date: "April 25, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(glue)
library(plotly)
library(stringi)
source("R/z_scores.R")
source("R/yahoo_api.R")
```


```{r}
# check if file exists, maybe move all in this chunk to a script
filename <- function(name) {
  paste0("data/",name,"_",gsub("-","",Sys.Date()),".Rds")
}

draft_results <- read_tsv("data/draftResults.tsv") %>% 
  clean_names() %>% 
  mutate(player = stri_trans_general(player, "latin-ascii"),
           round = ceiling(pick/12)) %>%  
  select(player, pick, round) %>% 
  rename(draft_pick = pick,
         draft_round = round)

get_team_rosters() -> rosters
rosters %>% 
  saveRDS(filename("rosters"))

yahoo_players <- get_players(2500)
yahoo_players %>% 
  saveRDS(filename("yahoo_players"))
  
all_players <- rosters %>% 
  select(player_id, team, manager) %>% 
  full_join(yahoo_players) %>% 
  clean_names() %>% 
  mutate(name_full = stri_trans_general(name_full, "latin-ascii"))

#TODO abstract projection filename
  
proj_batter <- add_z_scores_to_projections("data/depthChartProjections_ros_batters_20190513.csv","batter") 
proj_pitcher <- add_z_scores_to_projections("data/depthChartProjections_ros_pitchers_20190513.csv", "pitcher")
  
projections <- proj_batter %>% 
  bind_rows(proj_pitcher)


#TODO save these to some file
projections$Name[projections$Name == 'Enrique Hernandez'] <- "Kike Hernandez"
projections$Name[projections$Name == 'Peter Alonso'] <- "Pete Alonso"
projections$Name[projections$Name == 'Joshua James'] <- "Josh James"
projections$Name[projections$Name == 'Shin-Soo Choo'] <- "Shin-soo Choo"

#TODO test, include draft team
all_players %>% 
  full_join(draft_results, by = c("name_full" = "player")) %>% 
  full_join(projections, by = c("name_full" = "Name")) %>% 
  mutate(team = if_else(is.na(team),"Free Agent",team),
         team = fct_reorder(team, z_sum)) -> rosters_with_projections

rosters_with_projections %>% 
  saveRDS(filename("rosters_with_projections"))

```

```{r}
#TODO move to script (sets z_score above replacement, based on median z_score of rostered players, grouped by type [batter/pitcher])
rosters_with_projections %>% 
  filter(!type == 'NA', !team == 'Free Agent') %>%
  group_by(type) %>% 
  summarize(adj = median(z_sum)) -> z_sum_adj

rosters_with_adj_projections <- rosters_with_projections %>% 
  filter(!type == 'NA') %>% 
  mutate(zar = if_else(type=="batter",
                       z_sum-z_sum_adj$adj[z_sum_adj$type=="batter"],
                       z_sum-z_sum_adj$adj[z_sum_adj$type=="pitcher"]))

position_columns <- rosters_with_adj_projections %>%
    select(starts_with("eligible_positions")) %>%
    colnames()
  
rosters_with_adj_projections %>%
  mutate(positions = paste(!!! syms(position_columns), sep = "," )) %>%
  mutate(positions = gsub('NA', '', positions)) %>%
  mutate(positions = gsub("^,*|(?<=,),|,*$", "", positions, perl=T)) %>%
  select(-(starts_with("eligible_positions"))) -> rosters_with_adj_projections
```

```{r}
#TODO abstract some of these views
#FIXME some join issues here
rosters_with_adj_projections %>% 
  mutate(zar = round(zar)) %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 0)) %>% 
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type))) +
  coord_flip() -> pa

ggplotly(pa)

rosters_with_adj_projections %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 0)) %>% 
  arrange(zar %>% desc) %>% 
  select(name_full, display_position, type, zar) %>% 
  View()
```

```{r}
# TODO find way to wrap these three views into one
rosters_with_adj_projections %>% 
  filter(grepl("Plouffe|Utleys",team)) %>% 
  select(team, manager, name_full, display_position, zar) %>% 
  arrange(zar %>% desc) %>% 
  View()
  # mutate(zar = janitor::round_half_up(zar)) %>% 
  # write_csv("data/tradeReview_20190423.csv")

rosters_with_adj_projections %>% 
  filter(grepl("Plouffe|Utleys",team)) %>% 
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type)), width=.2) +
  coord_flip() -> tv

ggplotly(tv)

rosters_with_adj_projections %>% 
  filter(grepl("Plouffe|theriverbrew",team)) %>% 
  select(team, manager, name_full, display_position, zar) %>% 
  filter(grepl("deGrom|Lucchesi",name_full)) %>% 
  group_by(team) %>% 
  summarize(zar = sum(zar))
```

```{r}
rosters_with_adj_projections %>% 
  filter(!grepl("Free Agent",team),
  grepl("CF",positions)
       ) %>%
  ggplot(aes(x=team,y=zar,color=type)) +
  #geom_boxplot() +
  geom_jitter(aes(text=name_full), width = .2) +
  coord_flip() -> tb

ggplotly(tb)
```

```{r}
#TODO measuring projected value of draft picks, move to separate research
rosters_with_adj_projections %>% 
  filter(!is.na(draft_pick)) %>%
  group_by(draft_round) %>% 
  summarize(zar_median = median(zar) %>% janitor::round_half_up(),
            zar_mean = mean(zar) %>% janitor::round_half_up()) %>%
  ggplot(aes(x=draft_round,y=zar_mean)) +
  geom_col() +
  geom_line(aes(y=zar_median)) -> draft_plot

ggplotly(draft_plot)

rosters_with_adj_projections %>% 
  filter(!is.na(draft_pick)) %>% 
  group_by(draft_round) %>% 
  arrange(draft_round) %>% 
  ggplot(aes(x=draft_round,y=zar,group=draft_round)) +
  geom_boxplot()
```

