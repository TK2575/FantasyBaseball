---
title: "Roster Review (Generic)"
author: "Tom Kain"
date: "April 25, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(glue)
library(plotly)

source("R/helper.R")
```


```{r}
force <- TRUE
force_all <- FALSE
batter_file <- NULL
pitcher_file <- NULL

rosters <- load_players_with_projections(force, force_all, batter_file, pitcher_file)
```

```{r}
#TODO abstract some of these views
rosters %>% 
  mutate(zar = round(zar)) %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 0)) %>% 
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type))) +
  coord_flip() -> pa

ggplotly(pa)

rosters %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 0)) %>% 
  arrange(zar %>% desc) %>% 
  select(name_full, positions, type, zar) %>% 
  View()
```

```{r}
# TODO find way to wrap these three views into one
rosters %>% 
  filter(grepl("Plouffe|Utleys",team)) %>% 
  select(team, manager, name_full, display_position, zar) %>% 
  arrange(zar %>% desc) %>% 
  View()
  # mutate(zar = janitor::round_half_up(zar)) %>% 
  # write_csv("data/tradeReview_20190423.csv")

rosters %>% 
  filter(grepl("Plouffe|Utleys",team)) %>% 
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type)), width=.2) +
  coord_flip() -> tv

ggplotly(tv)

rosters %>% 
  filter(grepl("process|Dorn",team)) %>% 
  select(team, manager, name_full, display_position, zar) %>% 
  filter(grepl("Cain|Price|Romo|Trout|Whitley|Claudio",name_full)) %>% 
  group_by(team) %>% 
  summarize(zar = sum(zar))
```

```{r}
rosters %>% 
  filter(!grepl("Free Agent",team)
  #        ,
  # grepl("CF",positions)
       ) %>%
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_boxplot() +
  # geom_jitter(aes(text=name_full), width = .2) +
  coord_flip() -> tb

ggplotly(tb)
```

```{r}
#TODO measuring projected value of draft picks, move to separate research
rosters %>% 
  filter(!is.na(draft_pick)) %>%
  group_by(draft_round) %>% 
  summarize(zar_median = median(zar) %>% janitor::round_half_up(),
            zar_mean = mean(zar) %>% janitor::round_half_up()) %>%
  ggplot(aes(x=draft_round,y=zar_mean)) +
  geom_col() +
  geom_line(aes(y=zar_median)) -> draft_plot

ggplotly(draft_plot)

rosters %>% 
  filter(!is.na(draft_pick)) %>% 
  group_by(draft_round) %>% 
  arrange(draft_round) %>% 
  ggplot(aes(x=draft_round,y=zar,group=draft_round)) +
  geom_boxplot()
```

```{r}
#TODO move to separate research
#FIXME where is Robinson Chirinos?

rosters_by_position <- row_per_position(rosters)

rosters_by_position %>% 
  filter(team != "Free Agent") %>% 
  ggplot(aes(position, zar, color = position, alpha = zar)) +
  geom_point(aes(text=name_full)) +
  facet_wrap(~ team) -> team_pos

ggplotly(team_pos)

rosters_by_position %>% 
  filter(!is.na(manager)) %>% 
  group_by(position) %>% 
  count() %>% 
  ungroup() -> count_by_pos

rosters_by_position %>% 
  group_by(position) %>% 
  arrange(zar %>% desc()) %>% 
  mutate(num = row_number()) %>% 
  ungroup %>% 
  full_join(count_by_pos, "position") %>% 
  filter(num <= 1.5 * n) %>% 
  select(team, manager, name_full, position, zar) %>% View()
```