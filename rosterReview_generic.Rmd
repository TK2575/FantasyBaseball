---
title: "Roster Review (Generic)"
author: "Tom Kain"
date: "April 25, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(glue)
library(plotly)
library(stringi)
source("R/z_scores.R")
source("R/yahoo_api.R")
```


```{r}
filename <- function(name) {
  paste0("data/",name,"_",gsub("-","",Sys.Date()),".Rds")
}

draft_results <- read_tsv("data/draftResults.tsv") %>% 
    clean_names() %>% 
    mutate(player = stri_trans_general(player, "latin-ascii")) %>% 
    select(pick, player)

get_team_rosters() -> rosters
rosters %>% 
  saveRDS(filename("rosters"))

yahoo_players <- get_players(2500)
yahoo_players %>% 
  saveRDS(filename("yahoo_players"))
  
all_players <- rosters %>% 
  select(player_id, team, manager) %>% 
  full_join(yahoo_players) %>% 
  clean_names() %>% 
  mutate(name_full = stri_trans_general(name_full, "latin-ascii"))

#TODO abstract projection filename
  
proj_batter <- add_z_scores_to_projections("data/depthChartProjections_ros_batters_20190422.csv","batter") 
proj_pitcher <- add_z_scores_to_projections("data/depthChartProjections_ros_pitchers_20190422.csv", "pitcher")
  
projections <- proj_batter %>% 
  bind_rows(proj_pitcher)


#TODO save these to some file
projections$Name[projections$Name == 'Enrique Hernandez'] <- "Kike Hernandez"
projections$Name[projections$Name == 'Peter Alonso'] <- "Pete Alonso"
projections$Name[projections$Name == 'Joshua James'] <- "Josh James"

#TODO test, include draft team
all_players %>% 
  full_join(draft_results, by = c("name_full" = "player")) %>% 
  full_join(projections, by = c("name_full" = "Name")) %>% 
  mutate(team = if_else(is.na(team),"Free Agent",team),
         team = fct_reorder(team, z_sum)) -> rosters_with_projections

rosters_with_projections %>% 
  saveRDS(filename("rosters_with_projections"))

```

```{r}
#TODO move to script (sets z_score above replacement, based on median z_score of rostered players, grouped by type [batter/pitcher])
rosters_with_projections %>% 
  filter(!type == 'NA', !team == 'Free Agent') %>%
  group_by(type) %>% 
  summarize(adj = median(z_sum)) -> z_sum_adj

rosters_with_adj_projections <- rosters_with_projections %>% 
  filter(!type == 'NA') %>% 
  mutate(zar = if_else(type=="batter",
                       z_sum-z_sum_adj$adj[z_sum_adj$type=="batter"],
                       z_sum-z_sum_adj$adj[z_sum_adj$type=="pitcher"]))
```

```{r}
#TODO abstract some of these views
rosters_with_adj_projections %>% 
  mutate(zar = round(zar)) %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 0)) %>% 
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type))) +
  coord_flip() -> pa

ggplotly(pa)

rosters_with_adj_projections %>% 
  filter((team == 'Free Agent' & zar >=0) | (grepl("Plouffe",team) & zar < 0)) %>% 
  arrange(zar %>% desc) %>% 
  select(name_full, display_position, type, zar) %>% 
  View()
```

```{r}
rosters_with_adj_projections %>% 
  filter(grepl("Plouffe|Bat Lives",team)) %>% 
  select(team, manager, name_full, display_position, zar) %>% 
  arrange(zar %>% desc) %>% 
  View()
  # mutate(zar = janitor::round_half_up(zar)) %>% 
  # write_csv("data/tradeReview_20190423.csv")

rosters_with_adj_projections %>% 
  filter(grepl("Plouffe|Bat Lives",team)) %>% 
  select(team, manager, name_full, display_position, zar) %>% 
  filter(grepl("Bryant|deGrom|Bumgarner|Devers",name_full)) %>% 
  group_by(team) %>% 
  summarize(zar = sum(zar))
  
rosters_with_adj_projections %>% 
  filter(grepl("Plouffe|Painting",team)) %>% 
  ggplot(aes(x=team,y=zar,color=type)) +
  geom_jitter(aes(text=glue("{name_full} - {display_position}", color=type)), width=.2) +
  coord_flip() -> tv

ggplotly(tv)

rosters_with_adj_projections %>% 
  filter(grepl("Plouffe|Poofer",team)) %>% 
  select(team, manager, name_full, display_position, zar) %>% 
  filter(grepl("Bregman|Walker|deGrom|Lindor",name_full)) %>% 
  group_by(team) %>% 
  summarize(zar = sum(zar))
  

rosters_with_adj_projections %>% 
  filter(grepl("Plouffe|Painting",team)) %>% 
  select(team, manager, name_full, display_position, zar) %>% 
  filter(grepl("Santana|Robertson|deGrom|Devers",name_full)) %>% 
  group_by(team) %>% 
  summarize(zar = sum(zar))
```
```{r}
rosters_with_adj_projections %>% 
  filter(grepl("Free Agent|Plouffe",team),
         grepl("RP",display_position)) %>% 
  ggplot(aes(x=team,y=zar)) +
  geom_jitter(aes(text=name_full), width = .2) +
  coord_flip() -> tb

ggplotly(tb)
```