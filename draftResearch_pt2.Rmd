---
title: "Draft Research pt2"
author: "Tom Kain"
date: "March 8, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Custom player rankings

Goals:
1. Import projection data, as automated as possible
2. Generate ranks based on league stat categories using projection data via z-scores controlling for PA/IP
3. Determine a replacement-level performance and scale rankings accordingly

# Import
Info for getting depth chart projections:
[Batters](https://www.fangraphs.com/projections.aspx?pos=all&stats=bat&type=fangraphsdc&team=0&lg=all&players=0)


[Pitchers](https://www.fangraphs.com/projections.aspx?pos=all&stats=pit&type=fangraphsdc&team=0&lg=all&players=0)

Download to CSV via:
`javascript:__doPostBack('ProjectionBoard1$cmdCSV','')`

Downloading manually for now. The scoring categories for our league:
Batters: R, H, HR, RBI, SB, BB, K, OBP, OPS - Not included in data set: E
Pitchers: SV, K, HLD, ERA, WHIP - Not included in data set: NH, QS, BSV, CG, SHO

```{r}
pitchers_raw <- "data/depthChartProjections_pitchers_20190308.csv" %>%
  read_csv()
batters_raw <- "data/depthChartProjections_batters_20190308.csv" %>%
  read_csv()



pitchers <- pitchers_raw %>%
  select(playerid, 
         Name, 
         Team,
         ADP,
         IP,
         SV:ERA,
         SO,
         WHIP)
  
batters <- batters_raw %>%
  select(playerid,
         Name,
         Team,
         ADP,
         PA,
         H,
         HR:SO,
         SB,
         OBP,
         OPS)
```

# Generate rankings
```{r}
z_score_count <- function(df, stat, invert=FALSE) {
  stat <- enquo(stat)
  col_nm <- paste0("z_", quo_name(stat))
  
  df <- df %>% 
    mutate(s_z = (!! stat - mean(!! stat)) / sd(!! stat)) 
  
  if (invert) {
    df %>%
      mutate(s_z = -s_z) -> df
  }
  
  df %>%
   rename(!! col_nm := s_z)
} 

z_score_rate <- function(df, stat, quantity, invert=FALSE) {
  stat <- enquo(stat)
  quantity <- enquo(quantity)
  col_nm <- paste0("z_",quo_name(stat))
  
  df %>%
    mutate(s_q = (!! stat - mean(!! stat)) * !! quantity) %>%
    mutate(s_z = (s_q - mean(s_q)) / sd(s_q)) -> df
  
  if (invert) {
    df %>%
      mutate(s_z = -s_z) -> df
  }
  
  df %>%
    rename(!! col_nm := s_z) %>%
    select(-s_q)
}

(z_pitchers <- pitchers %>%
  filter(ADP < 999) %>%
  z_score_count(SV) %>%
  z_score_count(HLD) %>%
  z_score_rate(ERA, IP, TRUE) %>%
  z_score_count(SO) %>%
  z_score_rate(WHIP, IP, TRUE) %>%
  mutate(
    z_sum = pmap_dbl(
      select(., starts_with("z_")), 
      sum
    )
  ) %>%
  arrange(desc(z_sum))
)

(z_batters <- batters %>%
  filter(ADP < 999) %>%
  z_score_count(H) %>%
  z_score_count(HR) %>%
  z_score_count(R) %>%
  z_score_count(RBI) %>%
  z_score_count(BB) %>%
  z_score_count(SO, TRUE) %>%
  z_score_count(SB) %>%
  z_score_rate(OBP, PA) %>%
  z_score_rate(OPS, PA) %>%
  mutate(
    z_sum = pmap_dbl(
      select(., starts_with("z_")), 
      sum
    )
  ) %>%
  arrange(desc(z_sum))
)

z_batters %>% saveRDS("data/z_batters.Rds")
z_pitchers %>% saveRDS("data/z_pitchers.Rds")

z_batters %>% 
  mutate(type = "Batter") %>%
  bind_rows(z_pitchers) %>%
  select(playerid, Name, type, ADP, z_sum) %>%
  mutate(type = if_else(is.na(type), "Pitcher", type)) %>%
  arrange(z_sum %>% desc()) %>%
  ggplot(aes(x=ADP,y=z_sum,color=type)) +
  geom_point(aes(text=Name)) -> p

plotly::ggplotly(p)

```

### Missing Projection Data
Looking for some proxies for the following: NH, QS, BSV, CG, SHO, E. NH and SHO scarcity probably isn't worth diving in, probably just weight CG higher if I can project that. As for the remainders:

- Errors : research the correlation with Depth Chart's "FLD" metric to see if that's useful enough to weigh lightly. 
- BSV : Look at prior years' data to see the blown save rate and see if there's a predictable relationship to anything
- QS : once we've got a tally (find a source or summarize game logs), same idea as above
- CG : same

##### Errors
```{r}
fielding_standard <- "data/2018_Fielding-Standard.csv" %>%
  read_csv() %>%
  mutate(playerid = playerid %>% as.character())

fielding_advanced <- "data/2018_Fielding-Advanced.csv" %>%
  read_csv() %>%
  mutate(playerid = playerid %>% as.character()) %>%
  select(-(Name:Inn))

fielding <- fielding_standard %>%
  full_join(fielding_advanced, "playerid")

fielding %>%
  select(playerid, Pos, E, Def) %>%
  full_join(batters_raw, "playerid") %>%
  filter(ADP < 999) %>%
  select(Name, Team, Pos, E, Def, Fld) %>%
  filter(is.na(E))
  ggplot(aes(x=E,y=Fld)) +
  geom_point()

```
Incomplete listing, probably due to minimum qualified innings, but even with this sample (~ a third of the batters in the depth chart projections), not seeing a pattern. Since there is going to be at least one pitching category I won't be able to project, not having Errors should be ok.

##### CG
```{r}
hist_pitching <- "data/2016-2018_Pitching.csv" %>%
  read_csv()

hist_pitching %>%
  ggplot(aes(x=CG/3)) + 
  geom_histogram(binwidth=1)

hist_pitching %>%
  ggplot(aes(x=CG/3,y=IP/3)) +
  geom_point()
```
Looks like there were only two pitchers in the past three years that averaged 1 CG/year with less than 150 IP/year. Takeaway is to weigh IP a bit more. 

##### BSV
```{r}
hist_pitching %>%
  select(Name, Team, G, IP, ERA, SV, BS) %>%
  filter(SV > 0 | BS > 0) -> sv_pitching

sv_pitching %>%
  ggplot(aes(x=SV/3)) +
  geom_histogram(binwidth=1)

sv_pitching %>%
  ggplot(aes(x=SV/3,y=BS/3)) +
  geom_point()

sv_pitching %>%
  ggplot(aes(x=SV/3,y=IP/3)) +
  geom_point()

sv_pitching %>%
  ggplot(aes(x=BS/3,y=IP/3)) +
  geom_point()
```
As expected, not much with the existing data to correlate Blown Saves, so I the takeaway will probably be to more highly weigh ERA and WHIP. 

##### QS
```{r}

```

### To Do
1. Strategy for projecting scoring stats not in this data set (i.e. CG/SHO, etc)
2. Validate findings, control z-scores between batters and players to make them comparable
3. visualize - adjust plotly hover over detail to include player name (or maybe just playerid?)
4. Develop tiers of players (linear model? nearest neighbor?)
5. Replacement level stuff (new section)